{% extends "admin/admin_base.html" %}

{% block admin_content %}
<div class="container py-2">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>ğŸš€ å‘å¸ƒæ–°å¿ƒç†æŒ‡å—</h3>
        <a href="{{ url_for('admin.manage_guides') }}" class="btn btn-outline-secondary btn-sm">è¿”å›åˆ—è¡¨</a>
    </div>

    <form method="POST" class="card p-4 border-0 shadow-sm">
        <div class="row">
            <div class="col-md-4 border-end">
                <div class="mb-3">
                    <label class="form-label fw-bold small text-uppercase">å°é¢å›¾ URL</label>
                    <input type="text" name="cover_image_url" class="form-control" placeholder="ç²˜è´´ç²¾ç¾å›¾ç‰‡é“¾æ¥...">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold small text-uppercase">æ‰€å±åˆ†ç±»</label>
                    <select name="category_id" class="form-select">
                        {% for cat in categories %}
                        <option value="{{ cat.id }}">{{ cat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold small text-uppercase">é€‰æ‹©æ ‡ç­¾</label>
                    <div class="d-flex flex-wrap gap-2">
                        {% for tag in tags %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="tags" value="{{ tag.id }}" id="tag{{ tag.id }}">
                            <label class="form-check-label small" for="tag{{ tag.id }}">{{ tag.name }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        æŒ‡å—æ ‡é¢˜
                        <button type="button" id="ai-btn" class="btn btn-sm btn-outline-purple" style="border-color: #6f42c1; color: #6f42c1;">
                            âœ¨ AI ä¸€é”®æ¶¦è‰²/ç”Ÿæˆ
                        </button>
                    </label>
                    <input type="text" name="title" id="title-input" class="form-control form-control-lg" value="{{ guide.title if guide else '' }}">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold small">å†…å®¹æ‘˜è¦</label>
                    <textarea name="summary" class="form-control" rows="2"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold small">è¯¦ç»†å†…å®¹ (Markdown)</label>
                    <textarea name="content" class="form-control font-monospace" rows="12"></textarea>
                </div>
                <div class="text-end">
                    <button type="submit" class="btn btn-primary px-5 rounded-pill">å‘å¸ƒå†…å®¹</button>
                </div>
            </div>
        </div>
    </form>
</div>
<script>
document.getElementById('ai-btn').onclick = function() {
    const title = document.getElementById('title-input').value;
    if (!title) {
        alert("è¯·å…ˆè¾“å…¥ä¸€ä¸ªæ ‡é¢˜ï¼Œè®© AI çŸ¥é“å†™ä»€ä¹ˆå†…å®¹ã€‚");
        return;
    }

    // è§†è§‰åé¦ˆï¼šè¿›å…¥åŠ è½½çŠ¶æ€
    const originalText = this.innerHTML;
    this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> AI æ­£åœ¨æ€è€ƒä¸­...';
    this.disabled = true;

    fetch("{{ url_for('admin.ai_polish') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title: title })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            // è‡ªåŠ¨å¡«å……æ‘˜è¦å’Œæ­£æ–‡
            document.querySelector('textarea[name="summary"]').value = data.summary;
            document.querySelector('textarea[name="content"]').value = data.content;
            
            // å¦‚æœä½ ä½¿ç”¨äº† Markdown é¢„è§ˆï¼Œå¯ä»¥è§¦å‘é¢„è§ˆæ›´æ–°
            alert("âœ¨ AI åˆ›ä½œå®Œæˆï¼å·²è‡ªåŠ¨å¡«å…¥æ‘˜è¦å’Œæ­£æ–‡ã€‚");
        } else {
            alert("AI æš‚æ—¶æ‰çº¿äº†: " + data.message);
        }
    })
    .finally(() => {
        this.innerHTML = originalText;
        this.disabled = false;
    });
};
</script>

<style>
    .btn-outline-purple:hover { background-color: #6f42c1; color: white; }
</style>
{% endblock %}