{% extends "admin/admin_base.html" %}

{% block admin_content %}
<div class="container py-2">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>ğŸš€ å‘å¸ƒæ–°å¿ƒç†æŒ‡å—</h3>
        <a href="{{ url_for('admin.admin_guides.manage_guides') }}" class="btn btn-outline-secondary btn-sm">è¿”å›åˆ—è¡¨</a>
        <button class="btn btn-outline-secondary" type="button" data-bs-toggle="offcanvas" data-bs-target="#materialDrawer">
            ğŸ“‚ æ‰“å¼€ç´ æåº“
        </button>
    </div>
    <div class="offcanvas offcanvas-end w-50" tabindex="-1" id="materialDrawer">
        <div class="offcanvas-header border-bottom">
            <h5 class="offcanvas-title">ç´ æä¸­å¿ƒ</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <div id="drop-zone" class="card bg-light border-dashed p-4 mb-4 text-center" 
                style="border: 2px dashed #dee2e6; transition: all 0.3s ease; cursor: pointer;">
                <input type="file" id="quick-upload-input" class="d-none" onchange="handleFileUpload(this.files[0])">
                <div id="upload-icon" class="mb-2" style="font-size: 2rem;">âœ¨</div>
                <button class="btn btn-sm btn-purple rounded-pill px-4 mb-2" 
                        onclick="document.getElementById('quick-upload-input').click()">
                    ç‚¹å‡»æˆ–æ‹–æ‹½ç´ æè‡³æ­¤å¤„
                </button>
                <div id="upload-status" class="small text-muted">æ”¯æŒè§†é¢‘ã€éŸ³é¢‘åŠå„ç±»æ–‡æ¡£</div>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="select-all" onclick="toggleSelectAll(this)">
                    <label class="form-check-label small" for="select-all">å…¨é€‰</label>
                </div>
                <button id="batch-delete-btn" class="btn btn-sm btn-outline-danger d-none" onclick="handleBatchDelete()">
                    ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤ (<span id="select-count">0</span>)
                </button>
            </div>
            <div class="input-group mb-3 shadow-sm">
                <span class="input-group-text bg-white border-end-0">ğŸ”</span>
                <input type="text" id="material-search" class="form-control border-start-0 ps-0" 
                    placeholder="é€šè¿‡æ–‡ä»¶åæœç´¢å½“å‰åˆ†ç±»..." oninput="filterMaterials()">
            </div>

            <ul class="nav nav-pills mb-3" id="pills-tab">
                <li class="nav-item"><button class="nav-link active" onclick="loadMaterials('video', this)">è§†é¢‘</button></li>
                <li class="nav-item"><button class="nav-link" onclick="loadMaterials('audio', this)">éŸ³é¢‘</button></li>
                <li class="nav-item"><button class="nav-link" onclick="loadMaterials('image', this)">å›¾ç‰‡</button></li>
                <li class="nav-item"><button class="nav-link" onclick="loadMaterials('material', this)">å…¶ä»–ç´ æ</button></li>
            </ul>
            
            <div id="material-list" class="list-group list-group-flush">
            </div>
        </div>
    </div>
    <form method="POST" enctype="multipart/form-data" class="card p-4 border-0 shadow-sm">
        <div class="row">
            <div class="col-md-4 border-end">
                <div class="mb-3">
                    <label class="form-label fw-bold small text-uppercase">å°é¢å›¾ä¸Šä¼ </label>
                    <input type="file" name="cover_file" class="form-control mb-2" accept="image/*">
                    <div class="text-muted small">æˆ–è€…ç²˜è´´å›¾ç‰‡é“¾æ¥ï¼š</div>
                    <input type="text" name="cover_image_url" class="form-control mt-1" placeholder="http://...">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold small text-uppercase">æ‰€å±åˆ†ç±»</label>
                    <select name="category_id" class="form-select">
                        {% for cat in categories %}
                        <option value="{{ cat.id }}">{{ cat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold small text-uppercase">é€‰æ‹©æ ‡ç­¾</label>
                    <div class="d-flex flex-wrap gap-2">
                        {% for tag in tags %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="tags" value="{{ tag.id }}" id="tag{{ tag.id }}">
                            <label class="form-check-label small" for="tag{{ tag.id }}">{{ tag.name }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        æŒ‡å—æ ‡é¢˜
                        <button type="button" id="ai-btn" class="btn btn-sm btn-outline-purple" style="border-color: #6f42c1; color: #6f42c1;">
                            âœ¨ AI ä¸€é”®æ¶¦è‰²/ç”Ÿæˆ
                        </button>
                    </label>
                    <input type="text" name="title" id="title-input" class="form-control form-control-lg" value="{{ guide.title if guide else '' }}">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold small">å†…å®¹æ‘˜è¦</label>
                    <textarea name="summary" class="form-control" rows="2"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold small">è¯¦ç»†å†…å®¹ (Markdown)</label>
                    <textarea name="content" id="content-editor" class="form-control font-monospace" rows="12"></textarea>
                </div>
                <div class="text-end">
                    <button type="submit" class="btn btn-primary px-5 rounded-pill">å‘å¸ƒå†…å®¹</button>
                </div>
            </div>
        </div>
    </form>
</div>
<script>
document.getElementById('ai-btn').onclick = function() {
    const title = document.getElementById('title-input').value;
    if (!title) {
        alert("è¯·å…ˆè¾“å…¥ä¸€ä¸ªæ ‡é¢˜ï¼Œè®© AI çŸ¥é“å†™ä»€ä¹ˆå†…å®¹ã€‚");
        return;
    }

    // è§†è§‰åé¦ˆï¼šè¿›å…¥åŠ è½½çŠ¶æ€
    const originalText = this.innerHTML;
    this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> AI æ­£åœ¨æ€è€ƒä¸­...';
    this.disabled = true;

    fetch("{{ url_for('admin.admin_guides.ai_polish') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title: title })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            // è‡ªåŠ¨å¡«å……æ‘˜è¦å’Œæ­£æ–‡
            document.querySelector('textarea[name="summary"]').value = data.summary;
            document.querySelector('textarea[name="content"]').value = data.content;
            
            // å¦‚æœä½ ä½¿ç”¨äº† Markdown é¢„è§ˆï¼Œå¯ä»¥è§¦å‘é¢„è§ˆæ›´æ–°
            alert("âœ¨ AI åˆ›ä½œå®Œæˆï¼å·²è‡ªåŠ¨å¡«å…¥æ‘˜è¦å’Œæ­£æ–‡ã€‚");
        } else {
            alert("AI æš‚æ—¶æ‰çº¿äº†: " + data.message);
        }
    })
    .finally(() => {
        this.innerHTML = originalText;
        this.disabled = false;
    });
};
</script>

<script>
    let currentType = 'video'; // é»˜è®¤ä¸ºè§†é¢‘åˆ†ç±»
    let allLoadedMaterials = []; //
    // æ›´æ–°ç´ æä¸­å¿ƒæ‰€æœ‰ API è·¯å¾„ï¼Œç¡®ä¿æŒ‡å‘ materials è“å›¾
    // åœ¨ materials è“å›¾å®šä¹‰çš„ url_prefix æ˜¯ '/materials'
    const MATERIAL_API_BASE = "/admin/materials/api";

    function loadMaterials(type, element) {
        currentType = type;
        // 1. å¤„ç†é«˜äº®é€»è¾‘
        if (element) {
            const tabs = document.querySelectorAll('#pills-tab .nav-link');
            tabs.forEach(tab => tab.classList.remove('active'));
            element.classList.add('active');
        }

        const container = document.getElementById('material-list');
        container.innerHTML = '<div class="text-center p-4">åŠ è½½ä¸­...</div>';
        // æ¸…ç©ºæœç´¢æ¡†
        document.getElementById('material-search').value = '';

        fetch(`${MATERIAL_API_BASE}/my-media-system/${type}`)
            .then(res => res.json())
            .then(data => {
                if (data.files.length === 0) {
                    container.innerHTML = '<div class="text-center p-5 text-muted">æ­¤åˆ†ç±»ä¸‹æš‚æ— ç´ æ</div>';
                    return;
                }
                allLoadedMaterials = data.files || []; // ç¼“å­˜æ•°æ®
                renderMaterialList(allLoadedMaterials); // è°ƒç”¨æ¸²æŸ“å‡½æ•°
            })
            .catch(err => {
                container.innerHTML = `<div class="text-center p-4 text-danger small">è¯·æ±‚å¤±è´¥: ${err}</div>`;
            });
    }


    // æŸ¥æ‰¾ï¼š æ–°å¢ï¼šè¿‡æ»¤å‡½æ•°
    function filterMaterials() {
        const keyword = document.getElementById('material-search').value.toLowerCase();
        
        // æ ¹æ®æ–‡ä»¶åè¿›è¡Œè¿‡æ»¤
        const filtered = allLoadedMaterials.filter(file => 
            file.name.toLowerCase().includes(keyword)
        );
        
        renderMaterialList(filtered);
    }
    
    // 3. å°è£…ï¼šæ¸²æŸ“åˆ—è¡¨å‡½æ•° (æ•´åˆä½ ä¹‹å‰çš„é¢„è§ˆå›¾å’Œå›¾æ ‡é€»è¾‘)
    function renderMaterialList(files) {
        const container = document.getElementById('material-list');

        // --- å¼ºåˆ¶é‡ç½®å…¨é€‰æ¡†å’Œæ‰¹é‡æŒ‰é’® ---
        document.getElementById('select-all').checked = false;
        updateBatchBtn();

        if (files.length === 0) {
            container.innerHTML = '<div class="text-center p-5 text-muted small">æœªæ‰¾åˆ°åŒ¹é…çš„ç´ æ</div>';
            return;
        }

        container.innerHTML = files.map(file => {
            // --- å›¾æ ‡åˆ¤æ–­é€»è¾‘ ---
            const isPDF = file.name.toLowerCase().endsWith('.pdf');
            const isWord = file.name.toLowerCase().endsWith('.docx') || file.name.toLowerCase().endsWith('.doc');
            const isExcel = file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls');
            const isPPT = file.name.toLowerCase().endsWith('.pptx') || file.name.toLowerCase().endsWith('.ppt');

            let icon = 'ğŸ“„'; 
            if (isPDF) icon = 'ğŸ“•';
            else if (isWord) icon = 'ğŸ“˜';
            else if (isExcel) icon = 'ğŸ“—';
            else if (isPPT) icon = 'ğŸ“™';

            // --- è§†é¢‘å¤„ç†é€»è¾‘ ---
            const isVideo = file.name.match(/\.(mp4|webm|mov)$/i);
            // ä½¿ç”¨ t_2000 (2ç§’å¤„) é¿å¼€æŸäº›è§†é¢‘å¼€å¤´çš„é»‘å±ï¼Œå¹¶å¢åŠ å›¾ç‰‡è´¨é‡
            const videoPreview = isVideo ? `${file.url}?x-oss-process=video/snapshot,t_2000,f_jpg,w_100,h_75,m_fast` : '';

            return `
                <div class="list-group-item d-flex align-items-center gap-3 py-3">
                    <input class="form-check-input material-checkbox" type="checkbox" 
                        value="${file.path}" onchange="updateBatchBtn()">

                    <div class="flex-shrink-0 text-center" style="width: 60px;">
                        ${isVideo 
                            ? `<img src="${videoPreview}" class="rounded shadow-sm" style="width:60px; height:45px; object-fit:cover;" onerror="this.src='https://via.placeholder.com/60x45?text=Video'">` 
                            : `<span style="font-size: 1.5rem;">${icon}</span>`
                        }
                    </div>

                    <div class="flex-grow-1 overflow-hidden">
                        <div class="fw-bold small text-truncate" title="${file.name}">${file.name}</div>
                        <div class="text-muted" style="font-size: 0.7rem;">
                            ${(file.size/1024/1024).toFixed(2)} MB Â· ${file.last_modified || ''}
                        </div>
                    </div>

                    <button class="btn btn-sm btn-purple rounded-pill px-3" 
                            onclick="insertToEditor('${file.url}', '${file.name}')">
                        æ’å…¥
                    </button>

                    <button class="btn btn-sm btn-outline-primary rounded-pill px-2" onclick="copyToClipboard('${file.url}')">
                        ğŸ”—
                    </button>
                    <button class="btn btn-sm btn-outline-danger rounded-pill px-2" 
                            onclick="deleteMaterial('${file.path}', '${file.name}')">
                        ğŸ—‘ï¸
                    </button>
                </div>
            `;
        }).join('');
    }
        
    // è·å–æ‹–æ‹½åŒºåŸŸå…ƒç´ 
    const dropZone = document.getElementById('drop-zone');

    // 1. é˜»æ­¢æµè§ˆå™¨é»˜è®¤è¡Œä¸ºï¼ˆé˜²æ­¢æ‹–å…¥æ–‡ä»¶ç›´æ¥åœ¨æµè§ˆå™¨æ‰“å¼€ï¼‰
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, e => {
            e.preventDefault();
            e.stopPropagation();
        }, false);
    });

    // 2. æ‹–æ‹½ç§»å…¥/ç»è¿‡æ—¶çš„è§†è§‰æ•ˆæœ
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.style.borderColor = '#6f42c1'; // å˜ä¸ºç´«è‰²
            dropZone.style.backgroundColor = '#f8f4ff'; // èƒŒæ™¯å˜æ·¡ç´«
            document.getElementById('upload-icon').innerText = 'ğŸ“¥';
        }, false);
    });

    // 3. æ‹–æ‹½ç¦»å¼€æˆ–ç»“æŸæ—¶çš„è¿˜åŸæ•ˆæœ
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.style.borderColor = '#dee2e6';
            dropZone.style.backgroundColor = '#f8f9fa';
            document.getElementById('upload-icon').innerText = 'âœ¨';
        }, false);
    });

    // 4. å¤„ç†æ”¾ä¸‹æ–‡ä»¶
    dropZone.addEventListener('drop', e => {
        const file = e.dataTransfer.files[0];
        if (file) {
            handleFileUpload(file);
        }
    }, false);

    // 5. ç»Ÿä¸€çš„ä¸Šä¼ å‡½æ•°
    function handleFileUpload(file) {
        if (!file) return;
        
        const fileInput = document.getElementById('quick-upload-input');
        const status = document.getElementById('upload-status');
        status.innerHTML = `<span class="spinner-border spinner-border-sm text-purple"></span> æ­£åœ¨åŒæ­¥åˆ° ${currentType} ç›®å½•...`;
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('type', currentType); // ä½¿ç”¨å½“å‰é¡µç­¾çš„åˆ†ç±»

        fetch(`${MATERIAL_API_BASE}/upload`, {
            method: 'POST',
            body: formData
        })
        .then(res => {
            if (!res.ok) throw new Error('æ¥å£è¿”å› 404 æˆ–æœåŠ¡å™¨é”™è¯¯');
            return res.json();
        })
        .then(data => {
            if (data.success) {
                status.innerHTML = '<span class="text-success fw-bold">âœ… ä¸Šä¼ æˆåŠŸï¼</span>';
                // --- æ ¸å¿ƒä¿®å¤ï¼šæ¸…ç©ºè¾“å…¥æ¡†çš„å€¼ ---
                // è¿™æ ·ä¸‹æ¬¡å³ä½¿é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶ï¼Œä¹Ÿä¼šè§¦å‘ onchange äº‹ä»¶
                fileInput.value = '';
                // ç«‹å³åˆ·æ–°å½“å‰åˆ†ç±»åˆ—è¡¨
                loadMaterials(currentType); 
                setTimeout(() => status.innerText = 'æ”¯æŒè§†é¢‘ã€éŸ³é¢‘åŠå„ç±»æ–‡æ¡£', 3000);
            } else {
                alert('ä¸Šä¼ å¤±è´¥: ' + data.message);
                status.innerText = 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•';
            }
        });
    }

    function insertToEditor(url, fileName) {
        const editor = document.getElementById('content-editor');
        let markdown = '';

        // 1. æ ¹æ®åç¼€åè‡ªåŠ¨åˆ¤æ–­ Markdown æ ¼å¼
        const ext = fileName.split('.').pop().toLowerCase();
        if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
            markdown = `![${fileName}](${url})\n`; // å›¾ç‰‡æ ¼å¼
        } else if (['mp4', 'webm', 'mov'].includes(ext)) {
            // è§†é¢‘å»ºè®®ä½¿ç”¨ HTML æ ‡ç­¾ä»¥è·å¾—æ›´å¥½çš„æ’­æ”¾æ•ˆæœ
            markdown = `\n<video src="${url}" controls width="100%"></video>\n`;
        } else if (['mp3', 'wav', 'ogg'].includes(ext)) {
            markdown = `\n<audio src="${url}" controls></audio>\n`;
        } else {
            markdown = `[é™„ä»¶ï¼š${fileName}](${url})\n`; // æ™®é€šæ–‡ä»¶
        }

        // 2. è·å–å…‰æ ‡ä½ç½®å¹¶æ’å…¥å†…å®¹
        const startPos = editor.selectionStart;
        const endPos = editor.selectionEnd;
        const content = editor.value;

        // åœ¨å…‰æ ‡å¤„åˆ‡å¼€å­—ç¬¦ä¸²å¹¶æ’å…¥å†…å®¹
        editor.value = content.substring(0, startPos) + 
                    markdown + 
                    content.substring(endPos, content.length);

        // 3. é‡æ–°è®¾ç½®å…‰æ ‡ä½ç½®åˆ°æ’å…¥å†…å®¹ä¹‹å
        editor.focus();
        editor.selectionStart = startPos + markdown.length;
        editor.selectionEnd = startPos + markdown.length;

        // 4. å¯é€‰ï¼šæç¤ºç”¨æˆ·
        alert('å·²æ’å…¥åˆ°æ­£æ–‡');
    }

    function deleteMaterial(ossPath, fileName) {
        // 1. å®‰å…¨ç¡®è®¤
        if (!confirm(`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤ç´ æ "${fileName}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
            return;
        }

        // 2. å‘é€è¯·æ±‚
        fetch(`${MATERIAL_API_BASE}/delete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: ossPath })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // 3. æˆåŠŸåå±€éƒ¨åˆ·æ–°åˆ—è¡¨
                alert('åˆ é™¤æˆåŠŸ');
                loadMaterials(currentType); 
            } else {
                alert('åˆ é™¤å¤±è´¥: ' + data.message);
            }
        })
        .catch(err => alert('ç½‘ç»œé”™è¯¯: ' + err));
    }

    // æ›´æ–°æ‰¹é‡åˆ é™¤æŒ‰é’®çŠ¶æ€
    function updateBatchBtn() {
        const checkboxes = document.querySelectorAll('.material-checkbox:checked');
        const btn = document.getElementById('batch-delete-btn');
        const countSpan = document.getElementById('select-count');
        
        if (checkboxes.length > 0) {
            btn.classList.remove('d-none');
            countSpan.innerText = checkboxes.length;
        } else {
            btn.classList.add('d-none');
        }
    }

    // å…¨é€‰/å–æ¶ˆå…¨é€‰
    function toggleSelectAll(master) {
        const checkboxes = document.querySelectorAll('.material-checkbox');
        checkboxes.forEach(cb => cb.checked = master.checked);
        updateBatchBtn();
    }

    // æ‰§è¡Œæ‰¹é‡åˆ é™¤
    function handleBatchDelete() {
        const selected = Array.from(document.querySelectorAll('.material-checkbox:checked'))
                            .map(cb => cb.value);
        
        if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selected.length} ä¸ªæ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
            return;
        }

        fetch(`${MATERIAL_API_BASE}/delete_batch`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paths: selected })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                document.getElementById('select-all').checked = false;
                loadMaterials(currentType); // åˆ·æ–°åˆ—è¡¨
            } else {
                alert('åˆ é™¤å¤±è´¥: ' + data.message);
            }
        });
    }

    function copyToClipboard(url) {
        navigator.clipboard.writeText(url).then(() => {
            alert('é“¾æ¥å·²å¤åˆ¶ï¼Œå¯ç›´æ¥ç²˜è´´åˆ°ç¼–è¾‘å™¨ï¼');
        });
    }
    // ç¡®ä¿åœ¨é¡µé¢åŠ è½½åæ‰§è¡Œ,åŠ è½½è§†é¢‘
    window.addEventListener('load', function() {
        loadMaterials('video'); 
    });
</script>
<style>
    .btn-outline-purple:hover { background-color: #6f42c1; color: white; }
</style>
{% endblock %}