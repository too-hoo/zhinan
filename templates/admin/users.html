{% extends "admin/admin_base.html" %}  {% block admin_content %}
<div class="card shadow-sm mt-4">
    <div class="card-header bg-white py-3">
        <h4 class="mb-0">ğŸ‘¥ ç”¨æˆ·æƒé™ç®¡ç†åå°</h4>
    </div>
    <div class="card-body">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>ç”¨æˆ·å</th>
                    <th>å½“å‰çŠ¶æ€</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.id }}</td>
                    <td><strong>{{ user.username }}</strong></td>
                    <td>
                        {% if user.is_paid %}
                        <span class="badge bg-success">ä»˜è´¹ç”¨æˆ·</span>
                        {% else %}
                        <span class="badge bg-secondary">æ™®é€šç”¨æˆ·</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-approve {% if user.is_paid %}btn-outline-danger{% else %}btn-primary{% endif %}" 
                                data-user-id="{{ user.id }}">
                            <span class="btn-text">{% if user.is_paid %}å–æ¶ˆæˆæƒ{% else %}ä¸€é”®å¼€é€šæƒé™{% endif %}</span>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<script>
// å¼‚æ­¥å¤„ç†æƒé™åˆ‡æ¢
document.querySelectorAll('.btn-approve').forEach(btn => {
    btn.onclick = function() {
        const userId = this.getAttribute('data-user-id');
        const textSpan = this.querySelector('.btn-text');
        const badge = this.closest('tr').querySelector('.badge'); // æ‰¾åˆ°åŒä¸€è¡Œçš„çŠ¶æ€æ ‡ç­¾

        fetch(`/admin/approve/${userId}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                // 1. æ›´æ–°æŒ‰é’®æ ·å¼å’Œæ–‡å­—
                if(data.is_paid) {
                    this.classList.replace('btn-primary', 'btn-outline-danger');
                    textSpan.innerText = "å–æ¶ˆæˆæƒ";
                    badge.className = "badge bg-success";
                    badge.innerText = "ä»˜è´¹ç”¨æˆ·";
                } else {
                    this.classList.replace('btn-outline-danger', 'btn-primary');
                    textSpan.innerText = "ä¸€é”®å¼€é€šæƒé™";
                    badge.className = "badge bg-secondary";
                    badge.innerText = "æ™®é€šç”¨æˆ·";
                }
            }
        });
    };
});
</script>
<div class="card shadow-sm mt-4">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">ğŸ”‘ æ¿€æ´»ç ç®¡ç†</h5>
        <div class="btn-group">
            <button class="btn btn-outline-success btn-sm me-2" onclick="copyUnusedCodes()">
                ğŸ“‹ å¤åˆ¶æ‰€æœ‰å¯ç”¨ç 
            </button>
            <form action="{{ url_for('admin.generate_codes') }}" method="POST">
                <button class="btn btn-primary btn-sm">+ ç”Ÿæˆ10ä¸ªæ–°ç </button>
            </form>
        </div>
    </div>
    <div class="card-body">
        <div class="row row-cols-2 row-cols-md-5 g-2">
            {% for code in codes %}
            <div class="col">
                <div class="p-2 border rounded text-center {% if code.is_used %}bg-light text-muted{% else %}bg-white unused-code{% endif %}">
                    <small class="d-block fw-bold">{{ code.code }}</small>
                    <span class="badge {% if code.is_used %}bg-secondary{% else %}bg-success{% endif %}">
                        {{ 'å·²ç”¨' if code.is_used else 'å¯ç”¨' }}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
<script>
function copyUnusedCodes() {
    // 1. è·å–æ‰€æœ‰æ ‡è®°ä¸ºâ€œå¯ç”¨â€çš„æ¿€æ´»ç å…ƒç´ 
    const codeElements = document.querySelectorAll('.unused-code fw-bold, .unused-code .fw-bold');
    // å¦‚æœä¸Šé¢çš„é€‰æ‹©å™¨ä¸ç”Ÿæ•ˆï¼Œå¯ä»¥ç›´æ¥é€‰å–å¸¦æœ‰è¯¥ class å†…éƒ¨çš„æ–‡æœ¬
    const unusedCodes = Array.from(document.querySelectorAll('.unused-code'))
                             .map(el => el.querySelector('small').innerText);

    if (unusedCodes.length === 0) {
        alert("åº“ä¸­å·²æ²¡æœ‰å¯ç”¨çš„æ¿€æ´»ç ï¼");
        return;
    }

    // 2. å°†æ¿€æ´»ç åˆå¹¶æˆå¤šè¡Œæ–‡æœ¬ï¼ˆæ¯è¡Œä¸€ä¸ªç ï¼‰
    const textToCopy = unusedCodes.join('\n');

    // 3. è°ƒç”¨ç³»ç»Ÿå‰ªè´´æ¿ API
    navigator.clipboard.writeText(textToCopy).then(() => {
        alert("æˆåŠŸå¤åˆ¶ " + unusedCodes.length + " ä¸ªæ¿€æ´»ç ï¼å¯ä»¥å»å°çº¢ä¹¦ç²˜è´´äº†ã€‚");
    }).catch(err => {
        console.error('å¤åˆ¶å¤±è´¥: ', err);
        alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡å­—å¤åˆ¶ã€‚");
    });
}
</script>
{% endblock %}