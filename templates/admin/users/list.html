{% extends "admin/admin_base.html" %}

{% block admin_content %}
<div class="card shadow-sm mt-4">
    <div class="card-header bg-white py-3">
        <h4 class="mb-0">ğŸ‘¥ ç”¨æˆ·æƒé™ç®¡ç†</h4>
    </div>
    <div class="card-body">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>ç”¨æˆ·å</th>
                    <th>å½“å‰çŠ¶æ€</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.id }}</td>
                    <td><strong>{{ user.username }}</strong></td>
                    <td>
                        <span class="badge {% if user.is_paid %}bg-success{% else %}bg-secondary{% endif %}">
                            {{ 'ä»˜è´¹ç”¨æˆ·' if user.is_paid else 'æ™®é€šç”¨æˆ·' }}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-approve {% if user.is_paid %}btn-outline-danger{% else %}btn-primary{% endif %}" 
                                data-user-id="{{ user.id }}">
                            <span class="btn-text">{{ 'å–æ¶ˆæˆæƒ' if user.is_paid else 'ä¸€é”®å¼€é€šæƒé™' }}</span>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                
                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('admin.admin_users.list_users', page=pagination.prev_num) if pagination.has_prev else '#' }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo; ä¸Šä¸€é¡µ</span>
                    </a>
                </li>

                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if page_num %}
                        <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('admin.admin_users.list_users', page=page_num) }}">{{ page_num }}</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                {% endfor %}

                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('admin.admin_users.list_users', page=pagination.next_num) if pagination.has_next else '#' }}" aria-label="Next">
                        <span aria-hidden="true">ä¸‹ä¸€é¡µ &raquo;</span>
                    </a>
                </li>

            </ul>
        </nav>
        <div class="text-center text-muted small mt-2">
            å…± {{ pagination.total }} ä¸ªç”¨æˆ·ï¼Œå½“å‰ç¬¬ {{ pagination.page }} / {{ pagination.pages }} é¡µ
        </div>
    </div>
</div>

<script>
document.querySelectorAll('.btn-approve').forEach(btn => {
    btn.onclick = function() {
        const userId = this.getAttribute('data-user-id');
        const textSpan = this.querySelector('.btn-text');
        const badge = this.closest('tr').querySelector('.badge');

        // ä¿®æ­£ï¼šè¯·æ±‚è·¯å¾„éœ€åŒ¹é…æ–°çš„è“å›¾è·¯ç”±
        fetch(`/admin/users/authorize/${userId}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                if(data.is_paid) {
                    this.classList.replace('btn-primary', 'btn-outline-danger');
                    textSpan.innerText = "å–æ¶ˆæˆæƒ";
                    badge.className = "badge bg-success";
                    badge.innerText = "ä»˜è´¹ç”¨æˆ·";
                } else {
                    this.classList.replace('btn-outline-danger', 'btn-primary');
                    textSpan.innerText = "ä¸€é”®å¼€é€šæƒé™";
                    badge.className = "badge bg-secondary";
                    badge.innerText = "æ™®é€šç”¨æˆ·";
                }
            }
        });
    };
});
</script>
{% endblock %}