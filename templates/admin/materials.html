{% extends "admin/admin_base.html" %}

{% block admin_content %}
<div class="container-fluid py-4">
    <div class="card border-0 shadow-sm p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold mb-0">ğŸ“‚ é˜¿é‡Œäº‘ OSS ç´ æä¸­å¿ƒ</h3>
            <div class="text-muted small">ç›´æ¥ç®¡ç†è§†é¢‘ã€éŸ³é¢‘ã€å›¾ç‰‡åŠæ–‡æ¡£ç´ æ</div>
        </div>

        <div id="drop-zone" class="card bg-light border-dashed p-5 mb-4 text-center" 
             style="border: 2px dashed #6f42c1; transition: all 0.3s ease; cursor: pointer;">
            <input type="file" id="quick-upload-input" class="d-none" onchange="handleFileUpload(this.files[0])">
            <div id="upload-icon" class="mb-3" style="font-size: 3rem;">âœ¨</div>
            <h4 class="fw-bold">ç‚¹å‡»æˆ–å°†ç´ ææ‹–æ‹½è‡³æ­¤å¤„</h4>
            <div id="upload-status" class="text-muted">æ”¯æŒè§†é¢‘ã€éŸ³é¢‘åŠå„ç±»æ–‡æ¡£</div>
            <button class="btn btn-purple rounded-pill px-4 mt-3" 
                    onclick="document.getElementById('quick-upload-input').click()">
                é€‰æ‹©æ–‡ä»¶ä¸Šä¼ 
            </button>
        </div>

        <div class="row">
            <div class="col-md-3 border-end">
                <div class="p-2">
                    <label class="form-label fw-bold small text-uppercase">ç´ ææœç´¢</label>
                    <div class="input-group mb-4 shadow-sm">
                        <span class="input-group-text bg-white border-end-0">ğŸ”</span>
                        <input type="text" id="material-search" class="form-control border-start-0 ps-0" 
                               placeholder="è¾“å…¥æ–‡ä»¶åæœç´¢..." oninput="filterMaterials()">
                    </div>

                    <label class="form-label fw-bold small text-uppercase">æ–‡ä»¶åˆ†ç±»</label>
                    <div class="nav flex-column nav-pills" id="pills-tab">
                        <button class="nav-link active mb-2 text-start" onclick="loadMaterials('video', this)">ğŸ“¹ è§†é¢‘ç®¡ç†</button>
                        <button class="nav-link mb-2 text-start" onclick="loadMaterials('audio', this)">ğŸµ éŸ³é¢‘ç®¡ç†</button>
                        <button class="nav-link mb-2 text-start" onclick="loadMaterials('image', this)">ğŸ–¼ï¸ å›¾ç‰‡ç´ æ</button>
                        <button class="nav-link mb-2 text-start" onclick="loadMaterials('material', this)">ğŸ“„ å…¶ä»–æ–‡ä»¶</button>
                    </div>
                </div>
            </div>

            <div class="col-md-9">
                <div class="d-flex justify-content-between align-items-center mb-3 px-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="select-all" onclick="toggleSelectAll(this)">
                        <label class="form-check-label small" for="select-all">å½“å‰é¡µå…¨é€‰</label>
                    </div>
                    <button id="batch-delete-btn" class="btn btn-danger btn-sm d-none" onclick="handleBatchDelete()">
                        ğŸ—‘ï¸ æ‰¹é‡æ°¸ä¹…åˆ é™¤ (<span id="select-count">0</span>)
                    </button>
                </div>
                
                <div id="material-list" class="list-group list-group-flush shadow-sm rounded-3">
                    </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentType = 'video'; 
    let allLoadedMaterials = []; 
    // ç¡®ä¿è¿™é‡Œçš„è·¯å¾„ä¸ Python åç«¯å®šä¹‰çš„è“å›¾è·¯å¾„å®Œå…¨ä¸€è‡´
    const MATERIAL_API_BASE = "/admin/materials/api";

    function loadMaterials(type, element) {
        currentType = type;
        if (element) {
            const tabs = document.querySelectorAll('#pills-tab .nav-link');
            tabs.forEach(tab => tab.classList.remove('active'));
            element.classList.add('active');
        }

        const container = document.getElementById('material-list');
        container.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary"></div><br>åŠ è½½ç´ æä¸­...</div>';
        document.getElementById('material-search').value = '';

        // ä½¿ç”¨åå¼•å·ç¡®ä¿å˜é‡è§£ææ­£ç¡®
        fetch(`${MATERIAL_API_BASE}/my-media-system/${type}`)
            .then(res => res.json())
            .then(data => {
                if (data.files.length === 0) {
                    container.innerHTML = '<div class="text-center p-5 text-muted">æ­¤åˆ†ç±»ä¸‹æš‚æ— ç´ æ</div>';
                    return;
                }
                allLoadedMaterials = data.files || []; 
                renderMaterialList(allLoadedMaterials);
            })
            .catch(err => {
                container.innerHTML = `<div class="text-center p-5 text-danger">è¯·æ±‚å¤±è´¥: ${err}</div>`;
            });
    }

    function filterMaterials() {
        const keyword = document.getElementById('material-search').value.toLowerCase();
        const filtered = allLoadedMaterials.filter(file => file.name.toLowerCase().includes(keyword));
        renderMaterialList(filtered);
    }

    function renderMaterialList(files) {
        const container = document.getElementById('material-list');
        document.getElementById('select-all').checked = false;
        updateBatchBtn();

        container.innerHTML = files.map(file => {
            const isVideo = file.name.match(/\.(mp4|webm|mov)$/i);
            const preview = isVideo ? `${file.url}?x-oss-process=video/snapshot,t_2000,f_jpg,w_100,h_75,m_fast` : '';
            
            return `
                <div class="list-group-item d-flex align-items-center gap-3 py-3 border-start-0 border-end-0">
                    <input class="form-check-input material-checkbox" type="checkbox" value="${file.path}" onchange="updateBatchBtn()">
                    <div class="flex-shrink-0" style="width: 60px;">
                        ${isVideo ? `<img src="${preview}" class="rounded shadow-sm" style="width:60px; height:45px; object-fit:cover;">` : `<span style="font-size: 1.5rem;">ğŸ“„</span>`}
                    </div>
                    <div class="flex-grow-1 overflow-hidden">
                        <div class="fw-bold small text-truncate" title="${file.name}">${file.name}</div>
                        <div class="text-muted small">${(file.size/1024/1024).toFixed(2)} MB Â· ${file.last_modified}</div>
                    </div>
                    <div class="flex-shrink-0">
                        <button class="btn btn-sm btn-outline-primary rounded-pill px-3 me-2" onclick="copyToClipboard('${file.url}')">å¤åˆ¶é“¾æ¥</button>
                        <button class="btn btn-sm btn-outline-danger rounded-pill px-3" onclick="deleteMaterial('${file.path}', '${file.name}')">åˆ é™¤</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function handleFileUpload(file) {
        if (!file) return;
        const fileInput = document.getElementById('quick-upload-input');
        const status = document.getElementById('upload-status');
        status.innerHTML = `<span class="spinner-border spinner-border-sm text-purple"></span> åŒæ­¥è‡³ ${currentType} ç›®å½•...`;
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('type', currentType);

        // å¯¹åº” materials.py ä¸­çš„ @materials_bp.route('/api/upload')
        fetch(`${MATERIAL_API_BASE}/upload`, { method: 'POST', body: formData })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                status.innerHTML = '<span class="text-success fw-bold">âœ… ä¸Šä¼ æˆåŠŸï¼</span>';
                fileInput.value = '';
                loadMaterials(currentType); 
                setTimeout(() => status.innerText = 'æ”¯æŒè§†é¢‘ã€éŸ³é¢‘åŠå„ç±»æ–‡æ¡£', 3000);
            } else {
                alert('ä¸Šä¼ å¤±è´¥: ' + data.message);
                fileInput.value = '';
            }
        });
    }

    function deleteMaterial(ossPath, fileName) {
        if (!confirm(`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤ "${fileName}" å—ï¼Ÿ`)) return;
        fetch(`${MATERIAL_API_BASE}/delete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: ossPath })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                loadMaterials(currentType); 
            } else {
                alert('åˆ é™¤å¤±è´¥: ' + data.message);
            }
        });
    }

    function updateBatchBtn() {
        const checkboxes = document.querySelectorAll('.material-checkbox:checked');
        const btn = document.getElementById('batch-delete-btn');
        const countSpan = document.getElementById('select-count');
        if (checkboxes.length > 0) {
            btn.classList.remove('d-none');
            countSpan.innerText = checkboxes.length;
        } else {
            btn.classList.add('d-none');
        }
    }

    function toggleSelectAll(master) {
        document.querySelectorAll('.material-checkbox').forEach(cb => cb.checked = master.checked);
        updateBatchBtn();
    }

    function handleBatchDelete() {
        const selected = Array.from(document.querySelectorAll('.material-checkbox:checked')).map(cb => cb.value);
        if (!confirm(`åˆ é™¤é€‰ä¸­çš„ ${selected.length} ä¸ªç´ æï¼Ÿ`)) return;
        fetch(`${MATERIAL_API_BASE}/delete_batch`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paths: selected })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                loadMaterials(currentType); 
            }
        });
    }

    function copyToClipboard(url) {
        navigator.clipboard.writeText(url).then(() => alert('é“¾æ¥å·²å¤åˆ¶ï¼'));
    }

    window.onload = function() { loadMaterials('video'); };
</script>

<style>
    .border-dashed { border: 2px dashed #dee2e6 !important; }
    .btn-purple { background-color: #6f42c1; color: white; }
    .btn-purple:hover { background-color: #5a32a3; color: white; }
    .nav-pills .nav-link.active { background-color: #6f42c1; }
</style>
{% endblock %}