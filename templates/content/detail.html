{% extends "base.html" %}

{% block content %}
<div class="reading-progress-container">
    <div class="reading-progress-bar" id="readingProgress"></div>
</div>
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-9">
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb small">
                    <li class="breadcrumb-item"><a href="{{ url_for('content.list_guides') }}">æŒ‡å—åº“</a></li>
                    <li class="breadcrumb-item active">{{ guide.category.name if guide.category else 'æœªåˆ†ç±»' }}</li>
                </ol>
            </nav>

            <h1 class="display-5 fw-bold mb-3">{{ guide.title }}</h1>
            <div class="d-flex align-items-center justify-content-between mb-4 pb-3 border-bottom text-muted small">
                <div>
                    <span class="me-3">ğŸ“… {{ guide.updated_at.strftime('%Y-%m-%d') }}</span>
                    <span class="me-3">ğŸ‘ï¸ {{ guide.view_count }} æ¬¡é˜…è¯»</span>
                </div>
                <div class="d-flex gap-2">
                    {% for tag in guide.tags %}
                    <span class="badge rounded-pill bg-light text-secondary border">#{{ tag.name }}</span>
                    {% endfor %}
                </div>
            </div>

            {% if cover %}
            <div class="mb-5 shadow-sm rounded-4 overflow-hidden">
                <img src="{{ cover }}" class="img-fluid w-100" style="max-height: 400px; object-fit: cover;" alt="å°é¢">
            </div>
            {% endif %}

            <article class="guide-content lh-lg mb-5" id="markdown-body">
                {{ content | safe }}
            </article>

            <div class="text-center py-5 border-top border-bottom mb-5">
                <button class="btn btn-outline-danger btn-lg rounded-pill px-5" id="like-btn" data-id="{{ guide.id }}">
                    <span id="like-icon">ğŸ¤</span> è§‰å¾—æœ‰å¸®åŠ© (<span id="like-count">{{ guide.like_count }}</span>)
                </button>
                <button class="btn {% if guide in current_user.favorite_guides %}btn-warning{% else %}btn-outline-warning{% endif %} btn-lg rounded-pill px-5 ms-3" 
                        id="fav-btn" data-id="{{ guide.id }}">
                    <span id="fav-icon">{% if guide in current_user.favorite_guides %}â­{% else %}â˜†{% endif %}</span> 
                    <span id="fav-text">{% if guide in current_user.favorite_guides %}å·²æ”¶è—{% else %}åŠ å…¥æ”¶è—{% endif %}</span>
                </button>
            </div>

            <div class="related-section">
                <h4 class="fw-bold mb-4">âœ¨ ä½ å¯èƒ½ä¹Ÿæ„Ÿå…´è¶£</h4>
                <div class="row g-4">
                    {% for r_guide in related_guides %}
                    <div class="col-md-4">
                        <div class="card h-100 border-0 shadow-sm hover-up">
                            <a href="{{ url_for('content.show_guide', guide_id=r_guide.id) }}" class="text-decoration-none text-dark">
                                <img src="{{ r_guide.cover_image_url }}" class="card-img-top" style="height: 120px; object-fit: cover;">
                                <div class="card-body p-3">
                                    <h6 class="card-title fw-bold text-truncate">{{ r_guide.title }}</h6>
                                </div>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* æ ¸å¿ƒæ ·å¼ï¼šç¡®ä¿ Markdown é‡Œçš„è§†é¢‘å’ŒéŸ³é¢‘å®Œç¾é€‚é… */
    .guide-content video, .guide-content audio {
        width: 100% !important;
        border-radius: 12px;
        margin: 20px 0;
        background: #000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .guide-content img {
        max-width: 100%;
        border-radius: 8px;
        margin: 15px 0;
    }

    /* è¿›åº¦æ¡å¤–å£³ï¼šå›ºå®šåœ¨é¡¶éƒ¨ï¼Œé€æ˜èƒŒæ™¯ */
    .reading-progress-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: transparent;
        z-index: 2000; /* ç¡®ä¿åœ¨å¯¼èˆªæ ä¹‹ä¸Š */
    }

    /* è¿›åº¦æ¡ä¸»ä½“ï¼šå……æ»¡æ´»åŠ›çš„ç´«è‰²ï¼Œå¸¦ä¸€ç‚¹å‘å…‰æ•ˆæœ */
    .reading-progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(to right, #6f42c1, #a158ff);
        box-shadow: 0 0 8px rgba(111, 66, 193, 0.5);
        transition: width 0.1s ease-out; /* è®©ç§»åŠ¨æ›´é¡ºæ»‘ */
    }

    /* è§†é¢‘å¸ƒå±€ä¼˜åŒ–ï¼šæ¨¡ä»¿å¾®ä¿¡/ä¸»æµå¹³å°è´¨æ„Ÿ */
    .guide-content video {
        display: block;
        /* 1. æ ¸å¿ƒé™å®½ï¼šåœ¨å¤§å±å¹•ä¸Šä¸ä¼šæ— é™æ”¾å¤§ */
        max-width: 90%; 
        width: 720px; /* è®¾å®šä¸€ä¸ªç†æƒ³çš„å±•ç¤ºå®½åº¦ */
        
        /* 2. çºµå‘é™é«˜ï¼šé˜²æ­¢çºµå‘è§†é¢‘ï¼ˆå¦‚æ‰‹æœºå½•å±ï¼‰å æ»¡å…¨å± */
        max-height: 480px; 
        
        /* 3. å±…ä¸­æ˜¾ç¤º */
        margin: 32px auto; 
        
        /* 4. å®½é«˜æ¯”ä¿æŠ¤ï¼šä¿æŒæ ‡å‡†çš„ç”µå½±/ç”µè§†æ¯”ä¾‹ */
        aspect-ratio: 16 / 9; 
        
        /* 5. è§†è§‰è£…é¥° */
        border-radius: 16px; 
        background-color: #000; 
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); 
        
        /* ç¡®ä¿è§†é¢‘å†…å®¹åœ¨å®¹å™¨å†…ä¸è¢«è£å‰ª */
        object-fit: contain; 
    }

    /* é’ˆå¯¹æ‰‹æœºç«¯çš„é€‚é… */
    @media (max-width: 768px) {
        .guide-content video {
            max-width: 100%;
            width: 100%;
            aspect-ratio: auto; /* æ‰‹æœºç«¯å…è®¸æ ¹æ®è§†é¢‘åŸæ¯”ä¾‹æ˜¾ç¤º */
            border-radius: 8px;
            margin: 20px 0;
        }
    }
    .doc-btns .btn-outline-purple {
        border-color: #6f42c1;
        color: #6f42c1;
        border-radius: 20px;
    }
    .doc-btns .btn-outline-purple:hover {
        background-color: #6f42c1;
        color: white;
    }
    /* æ–‡æ¡£å¡ç‰‡åŸºç¡€æ ·å¼ */
    .doc-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 16px;
        margin: 20px 0;
        text-decoration: none !important;
        transition: all 0.3s ease;
    }

    .doc-card:hover {
        background: #f1f3f5;
        border-color: #6f42c1;
        transform: translateY(-2px);
    }

    /* å›¾æ ‡åŒºåŸŸ */
    .doc-icon {
        font-size: 2.5rem;
        margin-right: 16px;
        line-height: 1;
    }

    /* æ–‡å­—åŒºåŸŸ */
    .doc-info {
        flex-grow: 1;
        overflow: hidden;
    }

    .doc-name {
        color: #343a40;
        font-weight: 600;
        margin-bottom: 4px;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
    }

    .doc-meta {
        font-size: 0.8rem;
        color: #6c757d;
    }

    /* ä¸‹è½½æŒ‰é’®æ„Ÿ */
    .doc-action {
        color: #6f42c1;
        font-weight: bold;
        font-size: 0.9rem;
        margin-left: 12px;
    }

    /* è®©æ­£æ–‡ä¸­çš„å›¾ç‰‡ã€éŸ³é¢‘å’Œè§†é¢‘å…¨éƒ¨å±…ä¸­ä¸”ç¾åŒ– */
    .guide-content img, 
    .guide-content audio, 
    .guide-content video {
        display: block; /* è½¬æ¢ä¸ºå—çº§å…ƒç´  */
        margin: 30px auto; /* çºµå‘ç•™ç™½ 30pxï¼Œæ¨ªå‘è‡ªåŠ¨å±…ä¸­ */
        max-width: 90%; /* é™åˆ¶å®½åº¦ï¼Œé˜²æ­¢æº¢å‡º */
        box-shadow: 0 4px 15px rgba(0,0,0,0.08); /* å¢åŠ è½»å¾®é˜´å½±ï¼Œæå‡è´¨æ„Ÿ */
    }

    /* å½•éŸ³æ–‡ä»¶çš„ç‰¹æ®Šå¤„ç†ï¼šå®½åº¦é€‚ä¸­ï¼Œä¸è¦æ’‘æ»¡å…¨å± */
    .guide-content audio {
        width: 600px; 
        max-width: 100%; /* æ‰‹æœºç«¯è‡ªåŠ¨å›ç¼© */
        height: 45px;
        border-radius: 30px; /* åœ†è§’é£æ ¼ */
    }

    /* å›¾ç‰‡å¢åŠ åœ†è§’å’Œç‚¹å‡»ç¼©æ”¾æ„Ÿ */
    .guide-content img {
        border-radius: 12px;
        cursor: zoom-in;
        transition: transform 0.2s;
    }
    .guide-content img:hover {
        transform: scale(1.01);
    }
    
    /* templates/content/detail.html */
    .guide-content a[data-fslightbox] {
        display: block;
        text-align: center;
        transition: opacity 0.3s ease;
    }

    .guide-content a[data-fslightbox]:hover {
        opacity: 0.9;
    }

    /* åœ¨å›¾ç‰‡ä¸‹æ–¹å¢åŠ ä¸€ä¸ªå°æç¤ºï¼ˆå¯é€‰ï¼‰ */
    .guide-content a[data-fslightbox]::after {
        content: "ç‚¹å‡»æŸ¥çœ‹å¤§å›¾";
        display: block;
        font-size: 0.75rem;
        color: #adb5bd;
        margin-top: 8px;
    }
</style>

<script>
// 1. ç‚¹èµé€»è¾‘
document.getElementById('like-btn').onclick = function() {
    const guideId = this.getAttribute('data-id');
    const btn = this;

    // --- ä¿®å¤ç‚¹ï¼šè·¯å¾„æ”¹ä¸º /like/ ---
    fetch(`/like/${guideId}`, { method: 'POST' }) 
    .then(res => {
        if (!res.ok) throw new Error('404 Not Found'); // å¢åŠ é”™è¯¯å¤„ç†
        return res.json();
    })
    .then(data => {
        if(data.status === 'success') {
            document.getElementById('like-count').innerText = data.new_count;
            document.getElementById('like-icon').innerText = 'â¤ï¸';
            btn.classList.replace('btn-outline-danger', 'btn-danger');
            btn.disabled = true;
        }
    })
    .catch(err => console.error('ç‚¹èµè¯·æ±‚å¤±è´¥:', err));
};

// 2. æ”¶è—é€»è¾‘
document.getElementById('fav-btn').onclick = function() {
    const guideId = this.getAttribute('data-id');
    const btn = this;
    const icon = document.getElementById('fav-icon');
    const text = document.getElementById('fav-text');

    // --- ä¿®å¤ç‚¹ï¼šè·¯å¾„æ”¹ä¸º /favorite/ ---
    fetch(`/favorite/${guideId}`, { method: 'POST' }) 
    .then(res => {
        if (!res.ok) throw new Error('404 Not Found');
        return res.json();
    })
    .then(data => {
        if(data.status === 'success') {
            if(data.action === 'favorited') {
                btn.classList.replace('btn-outline-warning', 'btn-warning');
                icon.innerText = 'â­';
                text.innerText = 'å·²æ”¶è—';
            } else {
                btn.classList.replace('btn-warning', 'btn-outline-warning');
                icon.innerText = 'â˜†';
                text.innerText = 'åŠ å…¥æ”¶è—';
            }
        }
    })
    .catch(err => console.error('æ”¶è—è¯·æ±‚å¤±è´¥:', err));
};

// ç›‘å¬çª—å£æ»šåŠ¨äº‹ä»¶
window.onscroll = function() {
    updateReadingProgress();
};

function updateReadingProgress() {
    const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
    // è®¡ç®—æ–‡æ¡£çš„æ€»é«˜åº¦å‡å»å¯è§†åŒºåŸŸé«˜åº¦
    const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    // è®¡ç®—ç™¾åˆ†æ¯”
    const scrolled = (winScroll / height) * 100;
    
    // æ›´æ–°è¿›åº¦æ¡å®½åº¦
    const progressBar = document.getElementById("readingProgress");
    if (progressBar) {
        progressBar.style.width = scrolled + "%";
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const article = document.getElementById('markdown-body');
    const links = article.getElementsByTagName('a');

    const iconMap = {
        'pdf': 'ğŸ“•',
        'docx': 'ğŸ“˜', 'doc': 'ğŸ“˜',
        'xlsx': 'ğŸ“—', 'xls': 'ğŸ“—',
        'pptx': 'ğŸ“™', 'ppt': 'ğŸ“™',
        'zip': 'ğŸ“¦', 'rar': 'ğŸ“¦',
        'txt': 'ğŸ“„'
    };

    // å€’åºéå†ï¼Œé˜²æ­¢ä¿®æ”¹ DOM å½±å“ç´¢å¼•
    for (let i = links.length - 1; i >= 0; i--) {
        const link = links[i];
        const url = link.href.toLowerCase();
        
        // æå–åç¼€åï¼ˆè€ƒè™‘åˆ°å¯èƒ½æœ‰ç­¾åå‚æ•°ï¼Œå–è·¯å¾„éƒ¨åˆ†ï¼‰
        const path = link.getAttribute('href').split('?')[0];
        const ext = path.split('.').pop().toLowerCase();

        if (iconMap[ext]) {
            const fileName = link.innerText || 'ä¸‹è½½æ–‡ä»¶';
            const icon = iconMap[ext];

            // åˆ›å»ºå¡ç‰‡ç»“æ„
            const card = document.createElement('a');
            card.href = link.href;
            card.className = 'doc-card';
            card.innerHTML = `
                <div class="doc-icon">${icon}</div>
                <div class="doc-info">
                    <div class="doc-name">${fileName}</div>
                    <div class="doc-meta">ç‚¹å‡»å®‰å…¨é¢„è§ˆ/ä¸‹è½½ ${ext.toUpperCase()} æ–‡æ¡£</div>
                </div>
                <div class="doc-action">ç«‹å³æŸ¥çœ‹ â†’</div>
            `;
            
            // æ›¿æ¢åŸæœ‰çš„è¶…é“¾æ¥
            link.parentNode.replaceChild(card, link);
        }
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const article = document.getElementById('markdown-body');
    const links = article.getElementsByTagName('a');

    const iconMap = {
        'pdf': 'ğŸ“•', 'docx': 'ğŸ“˜', 'doc': 'ğŸ“˜',
        'xlsx': 'ğŸ“—', 'xls': 'ğŸ“—', 'pptx': 'ğŸ“™', 'ppt': 'ğŸ“™'
    };

    for (let i = links.length - 1; i >= 0; i--) {
        const link = links[i];
        const rawUrl = link.getAttribute('href');
        const path = rawUrl.split('?')[0];
        const ext = path.split('.').pop().toLowerCase();

        if (iconMap[ext]) {
            const fileName = link.innerText || 'æŸ¥çœ‹æ–‡æ¡£';
            const icon = iconMap[ext];
            let previewUrl = link.href;

            // --- æ ¸å¿ƒé€»è¾‘ï¼šæ ¹æ®æ–‡ä»¶ç±»å‹ç”Ÿæˆé¢„è§ˆåœ°å€ ---
            if (['docx', 'doc', 'xlsx', 'xls', 'pptx', 'ppt'].includes(ext)) {
                // ä½¿ç”¨å¾®è½¯æ¥å£é¢„è§ˆ Office æ–‡ä»¶ï¼Œéœ€è¦å¯¹åŸå§‹ URL è¿›è¡Œç¼–ç 
                previewUrl = `https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(link.href)}`;
            }

            const card = document.createElement('div');
            card.className = 'doc-card-wrapper mb-4';
            card.innerHTML = `
                <div class="doc-card">
                    <div class="doc-icon">${icon}</div>
                    <div class="doc-info">
                        <div class="doc-name">${fileName}</div>
                        <div class="doc-meta">æ–‡ä»¶ç±»å‹ï¼š${ext.toUpperCase()}</div>
                    </div>
                    <div class="doc-btns">
                        <a href="${previewUrl}" target="_blank" class="btn btn-sm btn-outline-purple me-2">åœ¨çº¿é˜…è¯»</a>
                        <a href="${link.href}" class="btn btn-sm btn-light">ä¸‹è½½</a>
                    </div>
                </div>
            `;
            
            link.parentNode.replaceChild(card, link);
        }
    }
});
document.addEventListener('DOMContentLoaded', function() {
    const article = document.getElementById('markdown-body');
    
    // --- æ–°å¢ï¼šå›¾ç‰‡ç¯ç®±å¤„ç†é€»è¾‘ ---
    const images = article.getElementsByTagName('img');
    for (let img of images) {
        // æ’é™¤æ‰å·²ç»æ˜¯é“¾æ¥çš„å›¾ç‰‡ï¼Œæˆ–è€…æ˜¯æŸäº›å°å›¾æ ‡
        if (img.parentNode.tagName !== 'A' && img.offsetWidth > 100) {
            const wrapper = document.createElement('a');
            
            // è®¾ç½®ç¯ç®±è§¦å‘å±æ€§
            wrapper.setAttribute('data-fslightbox', 'guide-gallery'); 
            wrapper.setAttribute('href', img.src); // ç‚¹å‡»åæ”¾å¤§çš„ç›®æ ‡åœ°å€
            wrapper.style.cursor = 'zoom-in';
            
            // å°†å›¾ç‰‡åŒ…è£¹èµ·æ¥
            img.parentNode.insertBefore(wrapper, img);
            wrapper.appendChild(img);
        }
    }

    // åˆ·æ–°ç¯ç®±æ’ä»¶ï¼Œç¡®ä¿åŠ¨æ€æ·»åŠ çš„é“¾æ¥ç”Ÿæ•ˆ
    refreshFsLightbox();

    // ... ä¹‹å‰çš„æ–‡æ¡£å¡ç‰‡å¤„ç†é€»è¾‘ ...
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fslightbox/3.0.9/index.min.js"></script>
{% endblock %}