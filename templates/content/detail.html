{% extends "base.html" %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-9">
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb small">
                    <li class="breadcrumb-item"><a href="{{ url_for('content.list_guides') }}">æŒ‡å—åº“</a></li>
                    <li class="breadcrumb-item active">{{ guide.category.name if guide.category else 'æœªåˆ†ç±»' }}</li>
                </ol>
            </nav>

            <h1 class="display-5 fw-bold mb-3">{{ guide.title }}</h1>
            <div class="d-flex align-items-center justify-content-between mb-4 pb-3 border-bottom text-muted small">
                <div>
                    <span class="me-3">ğŸ“… {{ guide.updated_at.strftime('%Y-%m-%d') }}</span>
                    <span class="me-3">ğŸ‘ï¸ {{ guide.view_count }} æ¬¡é˜…è¯»</span>
                </div>
                <div class="d-flex gap-2">
                    {% for tag in guide.tags %}
                    <span class="badge rounded-pill bg-light text-secondary border">#{{ tag.name }}</span>
                    {% endfor %}
                </div>
            </div>

            {% if cover %}
            <div class="mb-5 shadow-sm rounded-4 overflow-hidden">
                <img src="{{ cover }}" class="img-fluid w-100" style="max-height: 400px; object-fit: cover;" alt="å°é¢">
            </div>
            {% endif %}

            <article class="guide-content lh-lg mb-5" id="markdown-body">
                {{ content | safe }}
            </article>

            <div class="text-center py-5 border-top border-bottom mb-5">
                <button class="btn btn-outline-danger btn-lg rounded-pill px-5" id="like-btn" data-id="{{ guide.id }}">
                    <span id="like-icon">ğŸ¤</span> è§‰å¾—æœ‰å¸®åŠ© (<span id="like-count">{{ guide.like_count }}</span>)
                </button>
            </div>

            <div class="related-section">
                <h4 class="fw-bold mb-4">âœ¨ ä½ å¯èƒ½ä¹Ÿæ„Ÿå…´è¶£</h4>
                <div class="row g-4">
                    {% for r_guide in related_guides %}
                    <div class="col-md-4">
                        <div class="card h-100 border-0 shadow-sm hover-up">
                            <a href="{{ url_for('content.show_guide', guide_id=r_guide.id) }}" class="text-decoration-none text-dark">
                                <img src="{{ r_guide.cover_image_url }}" class="card-img-top" style="height: 120px; object-fit: cover;">
                                <div class="card-body p-3">
                                    <h6 class="card-title fw-bold text-truncate">{{ r_guide.title }}</h6>
                                </div>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* æ ¸å¿ƒæ ·å¼ï¼šç¡®ä¿ Markdown é‡Œçš„è§†é¢‘å’ŒéŸ³é¢‘å®Œç¾é€‚é… */
    .guide-content video, .guide-content audio {
        width: 100% !important;
        border-radius: 12px;
        margin: 20px 0;
        background: #000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .guide-content img {
        max-width: 100%;
        border-radius: 8px;
        margin: 15px 0;
    }
    .hover-up:hover { transform: translateY(-5px); transition: 0.3s; }
</style>

<script>
// ç‚¹èµ AJAX é€»è¾‘
document.getElementById('like-btn').onclick = function() {
    const guideId = this.getAttribute('data-id');
    const btn = this;

    fetch(`/content/like/${guideId}`, { method: 'POST' })
    .then(res => res.json())
    .then(data => {
        if(data.status === 'success') {
            document.getElementById('like-count').innerText = data.new_count;
            document.getElementById('like-icon').innerText = 'â¤ï¸';
            btn.classList.replace('btn-outline-danger', 'btn-danger');
            btn.disabled = true; // é˜²æ­¢é‡å¤ç‚¹èµ
        }
    });
};
</script>
{% endblock %}